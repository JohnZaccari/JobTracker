{"version":3,"sources":["detach/Detach.js"],"names":["async","projectRoot","let","user","await","UserManager","ensureLoggedInAsync","Error","username","exp","ProjectUtils","readConfigJsonAsync","experienceName","slug","experienceUrl","hasIosDirectory","_isDirectory","path","join","hasAndroidDirectory","ErrorCode","DIRECTORY_ALREADY_EXISTS","process","platform","response","yesnoAsync","console","log","configName","configFilenameAsync","name","android","package","sdkVersion","majorSdkVersion","parseSdkMajorVersion","versions","Versions","versionsAsync","sdkVersionConfig","sdkVersions","androidExpoViewUrl","iosExpoViewUrl","env","EXPO_VIEW_DIR","warn","isDetached","detach","scheme","detachedUUID","uuid","v4","replace","expoDirectory","mkdirp","sync","iosClientVersion","iosVersion","detachIOSAsync","supportingDirectory","getIosPaths","ios","publishBundlePath","relative","publishManifestPath","androidDirectory","rimraf","detachAndroidAsync","nameToWrite","expo","fs","promise","writeFile","JSON","stringify","detachAsync","configFilePath","detachedSDKVersion","kernelSDKVersion","IosPlist","modifyAsync","versionConfig","detachedNativeVersions","shell","kernel","configureDetachedVersionsPlistAsync","manifest","result","config","CFBundleURLTypes","CFBundleURLSchemes","push","UIDeviceFamily","usageKeysConfigured","key","hasOwnProperty","indexOf","length","forEach","configureDetachedIOSInfoPlistAsync","cleanBackupAsync","cleanPropertyListBackupsAsync","templateProjUrl","iosProjectDirectory","projectName","expoTemplateDirectory","Api","downloadAsync","extract","Utils","ncpAsync","_renameAndMoveIOSFilesAsync","iconPath","configureStandaloneIOSInfoPlistAsync","infoPlist","configureStandaloneIOSShellPlistAsync","IosIcons","createAndWriteIconsToPathAsync","podfileSubstitutions","TARGET_NAME","REACT_NATIVE_PATH","EXPOKIT_TAG","EXPOKIT_TAG_IOS","EXPOKIT_PATH","renderPodfileAsync","rimrafDontThrow","projectDirectory","gitIgnorePath","existsSync","e","filesToTransform","bundleIdentifier","Promise","all","map","fileName","transformFileContentsAsync","fileString","filesToMove","destFileName","dirname","extname","spawnAsync","filename","regex","file","readFile","toString","regexFileAsync","directory","originalPkg","destPkg","originalSplitPackage","split","originalDeepDirectory","i","tmpDirectory","newSplitPackage","newDeepDirectory","renamePackageAsync","expoViewUrl","tmpExpoDirectory","androidProjectDirectory","appBuildGradle","androidManifest","mainActivity","packageName","ANDROID_TEMPLATE_PKG","packageNameMatches","glob","oldPkgRegex","RegExp","appName","resolve","ANDROID_TEMPLATE_NAME","icon","iconMatches","unlink","saveImageToPathAsync","doesBuildConstantsExist","createBlankAsync","ensureBuildConstantsExistsIOSAsync","projectDir","args","podsDirectory","rnPodDirectory","rnFilesToDelete","skipXcodeConfig","expoKitVersion","podfileLockPath","podfileLock","expoKitVersionRegex","match","exec","devUrl","UrlUtils","constructManifestUrlAsync","constantsConfig","developmentUrl","EXPO_RUNTIME_VERSION","prepareDetachedBuildIosAsync","expoBuildConstantsMatches","expoBuildConstants","prepareDetachedBuildAsync","ANDROID_TEMPLATE_COMPANY","dir","statSync","isDirectory","question","yesno","ask","ok","projectNameLabel","toLowerCase"],"mappings":"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","file":"../../detach/Detach.js","sourcesContent":["// Copyright 2015-present 650 Industries. All rights reserved.\n/**\n * @flow\n */\n\n'use strict';\n\n// Set EXPO_VIEW_DIR to universe/exponent to test locally\n\nimport 'instapromise';\n\nimport mkdirp from 'mkdirp';\nimport fs from 'fs';\nimport path from 'path';\nimport rimraf from 'rimraf';\nimport glob from 'glob';\nimport uuid from 'uuid';\nimport yesno from 'yesno';\n\nimport {\n  parseSdkMajorVersion,\n  saveImageToPathAsync,\n  spawnAsyncThrowError,\n  spawnAsync,\n  transformFileContentsAsync,\n} from './ExponentTools';\nimport {\n  configureStandaloneIOSInfoPlistAsync,\n  configureStandaloneIOSShellPlistAsync,\n} from './IosShellApp';\nimport { renderPodfileAsync } from './IosPodsTools.js';\n\nimport * as IosIcons from './IosIcons';\nimport * as IosPlist from './IosPlist';\n\nimport Api from '../Api';\nimport ErrorCode from '../ErrorCode';\nimport * as ProjectUtils from '../project/ProjectUtils';\nimport UserManager from '../User';\nimport XDLError from '../XDLError';\nimport * as UrlUtils from '../UrlUtils';\nimport * as Utils from '../Utils';\nimport * as Versions from '../Versions';\n\nconst ANDROID_TEMPLATE_PKG = 'detach.app.template.pkg.name';\nconst ANDROID_TEMPLATE_COMPANY = 'detach.app.template.company.domain';\nconst ANDROID_TEMPLATE_NAME = 'DetachAppTemplate';\n\nfunction _isDirectory(dir) {\n  try {\n    if (fs.statSync(dir).isDirectory()) {\n      return true;\n    }\n\n    return false;\n  } catch (e) {\n    return false;\n  }\n}\n\nfunction yesnoAsync(question) {\n  return new Promise(resolve => {\n    yesno.ask(question, null, ok => {\n      resolve(ok);\n    });\n  });\n}\n\nexport async function detachAsync(projectRoot: string) {\n  let user = await UserManager.ensureLoggedInAsync();\n\n  if (!user) {\n    throw new Error(\n      'Internal error -- somehow detach is being run in offline mode.'\n    );\n  }\n\n  let username = user.username;\n  let { exp } = await ProjectUtils.readConfigJsonAsync(projectRoot);\n  let experienceName = `@${username}/${exp.slug}`;\n  let experienceUrl = `exp://exp.host/${experienceName}`;\n\n  // Check to make sure project isn't fully detached already\n  let hasIosDirectory = _isDirectory(path.join(projectRoot, 'ios'));\n  let hasAndroidDirectory = _isDirectory(path.join(projectRoot, 'android'));\n\n  if (hasIosDirectory && hasAndroidDirectory) {\n    throw new XDLError(\n      ErrorCode.DIRECTORY_ALREADY_EXISTS,\n      'Error detaching. `ios` and `android` directories already exist.'\n    );\n  }\n\n  // Project was already detached on Windows or Linux\n  if (\n    !hasIosDirectory &&\n    hasAndroidDirectory &&\n    process.platform === 'darwin'\n  ) {\n    let response = await yesnoAsync(\n      `This will add an Xcode project and leave your existing Android project alone. Enter 'yes' to continue:`\n    );\n    if (!response) {\n      console.log('Exiting...');\n      return false;\n    }\n  }\n\n  if (hasIosDirectory && !hasAndroidDirectory) {\n    throw new Error(\n      '`ios` directory already exists. Please remove it and try again.'\n    );\n  }\n\n  console.log('Validating project manifest...');\n  const configName = await ProjectUtils.configFilenameAsync(projectRoot);\n  if (!exp.name) {\n    throw new Error(`${configName} is missing \\`name\\``);\n  }\n\n  if (!exp.android || !exp.android.package) {\n    throw new Error(\n      `${configName} is missing android.package field. See https://docs.expo.io/versions/latest/guides/configuration.html#package`\n    );\n  }\n\n  if (!exp.sdkVersion) {\n    throw new Error(`${configName} is missing \\`sdkVersion\\``);\n  }\n\n  let majorSdkVersion = parseSdkMajorVersion(exp.sdkVersion);\n  if (majorSdkVersion < 16) {\n    throw new Error(\n      `${configName} must be updated to SDK 16.0.0 or newer to be detached.`\n    );\n  }\n\n  const versions = await Versions.versionsAsync();\n  let sdkVersionConfig = versions.sdkVersions[exp.sdkVersion];\n  if (\n    !sdkVersionConfig ||\n    !sdkVersionConfig.androidExpoViewUrl ||\n    !sdkVersionConfig.iosExpoViewUrl\n  ) {\n    if (process.env.EXPO_VIEW_DIR) {\n      console.warn(\n        `Detaching is not supported for SDK ${exp.sdkVersion}; ignoring this because you provided EXPO_VIEW_DIR`\n      );\n      sdkVersionConfig = {};\n    } else {\n      throw new Error(\n        `Detaching is not supported for SDK version ${exp.sdkVersion}`\n      );\n    }\n  }\n\n  if (process.platform !== 'darwin') {\n    console.warn(\n      `It appears you are trying to detach outside of macOS. You will require Xcode to build the resulting artefact.`\n    );\n  }\n\n  // Modify exp.json\n  exp.isDetached = true;\n\n  if (!exp.detach) {\n    exp.detach = {};\n  }\n\n  if (!exp.detach.scheme) {\n    let detachedUUID = uuid.v4().replace(/-/g, '');\n    exp.detach.scheme = `exp${detachedUUID}`;\n  }\n\n  let expoDirectory = path.join(projectRoot, '.expo-source');\n  mkdirp.sync(expoDirectory);\n\n  // iOS\n  if (!hasIosDirectory) {\n    const iosClientVersion = sdkVersionConfig.iosVersion\n      ? sdkVersionConfig.iosVersion\n      : versions.iosVersion;\n    await detachIOSAsync(\n      projectRoot,\n      exp.sdkVersion,\n      experienceUrl,\n      exp,\n      sdkVersionConfig.iosExpoViewUrl,\n      iosClientVersion\n    );\n    const { supportingDirectory } = getIosPaths(projectRoot, exp);\n    exp.detach.iosExpoViewUrl = sdkVersionConfig.iosExpoViewUrl;\n    exp.ios.publishBundlePath = path.relative(\n      projectRoot,\n      path.join(supportingDirectory, 'shell-app.bundle')\n    );\n    exp.ios.publishManifestPath = path.relative(\n      projectRoot,\n      path.join(supportingDirectory, 'shell-app-manifest.json')\n    );\n  }\n\n  // Android\n  if (!hasAndroidDirectory) {\n    let androidDirectory = path.join(expoDirectory, 'android');\n    rimraf.sync(androidDirectory);\n    mkdirp.sync(androidDirectory);\n    await detachAndroidAsync(\n      projectRoot,\n      androidDirectory,\n      exp.sdkVersion,\n      experienceUrl,\n      exp,\n      sdkVersionConfig.androidExpoViewUrl\n    );\n    exp.detach.androidExpoViewUrl = sdkVersionConfig.androidExpoViewUrl;\n  }\n\n  console.log('Writing ExpoKit configuration...');\n  // Update exp.json/app.json\n  // if we're writing to app.json, we need to place the configuration under the expo key\n  const nameToWrite = await ProjectUtils.configFilenameAsync(projectRoot);\n  if (nameToWrite === 'app.json') {\n    exp = { expo: exp };\n  }\n  await fs.promise.writeFile(\n    path.join(projectRoot, nameToWrite),\n    JSON.stringify(exp, null, 2)\n  );\n\n  console.log(\n    'Finished detaching your project! Look in the `android` and `ios` directories for the respective native projects. Follow the ExpoKit guide at https://docs.expo.io/versions/latest/guides/expokit.html to get your project running.\\n'\n  );\n  return true;\n}\n\nfunction getIosPaths(projectRoot, manifest) {\n  let iosProjectDirectory = path.join(projectRoot, 'ios');\n  let projectName;\n  let supportingDirectory;\n  if (manifest && manifest.name) {\n    let projectNameLabel = manifest.name;\n    projectName = projectNameLabel.replace(/[^a-z0-9_\\-]/gi, '-').toLowerCase();\n    supportingDirectory = path.join(\n      iosProjectDirectory,\n      projectName,\n      'Supporting'\n    );\n  } else {\n    throw new Error(\n      'Cannot configure an ExpoKit app with no name. Are you missing `exp.json`?'\n    );\n  }\n  return {\n    iosProjectDirectory,\n    projectName,\n    supportingDirectory,\n  };\n}\n\nfunction rimrafDontThrow(directory) {\n  try {\n    rimraf.sync(directory);\n  } catch (e) {\n    console.warn(\n      `There was an issue cleaning up, but your project should still work. You may need to manually remove ${directory}. (${e})`\n    );\n  }\n}\n\nasync function configureDetachedVersionsPlistAsync(\n  configFilePath,\n  detachedSDKVersion,\n  kernelSDKVersion\n) {\n  await IosPlist.modifyAsync(configFilePath, 'EXSDKVersions', versionConfig => {\n    versionConfig.sdkVersions = [detachedSDKVersion];\n    versionConfig.detachedNativeVersions = {\n      shell: detachedSDKVersion,\n      kernel: kernelSDKVersion,\n    };\n    return versionConfig;\n  });\n}\n\nasync function configureDetachedIOSInfoPlistAsync(configFilePath, manifest) {\n  let result = await IosPlist.modifyAsync(configFilePath, 'Info', config => {\n    // add detached scheme\n    if (manifest.isDetached && manifest.detach.scheme) {\n      if (!config.CFBundleURLTypes) {\n        config.CFBundleURLTypes = [\n          {\n            CFBundleURLSchemes: [],\n          },\n        ];\n      }\n      config.CFBundleURLTypes[0].CFBundleURLSchemes.push(\n        manifest.detach.scheme\n      );\n    }\n    if (config.UIDeviceFamily) {\n      delete config.UIDeviceFamily;\n    }\n    // configure *UsageDescription\n    let usageKeysConfigured = [];\n    for (let key in config) {\n      if (\n        config.hasOwnProperty(key) &&\n        key.indexOf('UsageDescription') !== -1\n      ) {\n        config[key] = config[key].replace('Expo experiences', 'this app');\n        usageKeysConfigured.push(key);\n      }\n    }\n    if (usageKeysConfigured.length) {\n      console.log(\n        'We added some permissions keys to `Info.plist` in your detached iOS project:'\n      );\n      usageKeysConfigured.forEach(key => {\n        console.log(`  ${key}`);\n      });\n      console.log(\n        'You may want to revise them to include language appropriate to your project. You can also remove them if your app will never use the corresponding API. See the Apple docs for these keys.'\n      );\n    }\n    return config;\n  });\n  return result;\n}\n\nasync function cleanPropertyListBackupsAsync(configFilePath) {\n  await IosPlist.cleanBackupAsync(configFilePath, 'EXShell', false);\n  await IosPlist.cleanBackupAsync(configFilePath, 'Info', false);\n  await IosPlist.cleanBackupAsync(configFilePath, 'EXSDKVersions', false);\n}\n\n/**\n *  Create a detached Expo iOS app pointing at the given project.\n */\nexport async function detachIOSAsync(\n  projectRoot: string,\n  sdkVersion: string,\n  experienceUrl: string,\n  manifest: any,\n  templateProjUrl: string,\n  iosClientVersion: string\n) {\n  let { iosProjectDirectory, projectName, supportingDirectory } = getIosPaths(\n    projectRoot,\n    manifest\n  );\n\n  let expoTemplateDirectory;\n  if (process.env.EXPO_VIEW_DIR) {\n    // Only for testing\n    expoTemplateDirectory = process.env.EXPO_VIEW_DIR;\n  } else {\n    expoTemplateDirectory = path.join(projectRoot, 'temp-ios-directory');\n    mkdirp.sync(expoTemplateDirectory);\n    console.log('Downloading iOS code...');\n    await Api.downloadAsync(templateProjUrl, expoTemplateDirectory, {\n      extract: true,\n    });\n  }\n\n  // copy downloaded template xcodeproj into the user's project.\n  // HEY: if you need other paths into the extracted archive, be sure and include them\n  // when the archive is generated in `ios/pipeline.js`\n  console.log('Moving iOS project files...');\n  await Utils.ncpAsync(\n    path.join(expoTemplateDirectory, 'exponent-view-template', 'ios'),\n    iosProjectDirectory\n  );\n\n  // rename the xcodeproj (and various other things) to the detached project name.\n  console.log('Naming iOS project...');\n  await _renameAndMoveIOSFilesAsync(iosProjectDirectory, projectName, manifest);\n\n  // use the detached project manifest to configure corresponding native parts\n  // of the detached xcodeproj. this is mostly the same configuration used for\n  // shell apps.\n  console.log('Configuring iOS project...');\n  let iconPath = `${iosProjectDirectory}/${projectName}/Assets.xcassets/AppIcon.appiconset`;\n  await configureStandaloneIOSInfoPlistAsync(supportingDirectory, manifest);\n  let infoPlist = await configureDetachedIOSInfoPlistAsync(\n    supportingDirectory,\n    manifest\n  );\n  await configureStandaloneIOSShellPlistAsync(\n    supportingDirectory,\n    manifest,\n    experienceUrl\n  );\n  // TODO: logic for when kernel sdk version is different from detached sdk version\n  await configureDetachedVersionsPlistAsync(\n    supportingDirectory,\n    sdkVersion,\n    sdkVersion\n  );\n  await IosIcons.createAndWriteIconsToPathAsync(\n    manifest,\n    iconPath,\n    projectRoot\n  );\n  // we don't pre-cache JS in this case, TODO: think about whether that's correct\n\n  // render Podfile in new project\n  console.log('Configuring iOS dependencies...');\n\n  let podfileSubstitutions = {\n    TARGET_NAME: projectName,\n    REACT_NATIVE_PATH: path.relative(\n      iosProjectDirectory,\n      path.join(projectRoot, 'node_modules', 'react-native')\n    ),\n    EXPOKIT_TAG: `ios/${iosClientVersion}`,\n  };\n  if (process.env.EXPOKIT_TAG_IOS) {\n    console.log(`EXPOKIT_TAG_IOS: Using custom ExpoKit iOS tag...`);\n    podfileSubstitutions.EXPOKIT_TAG = process.env.EXPOKIT_TAG_IOS;\n  } else if (process.env.EXPO_VIEW_DIR) {\n    console.log('EXPO_VIEW_DIR: Using local ExpoKit source for iOS...');\n    podfileSubstitutions.EXPOKIT_PATH = path.relative(\n      iosProjectDirectory,\n      process.env.EXPO_VIEW_DIR\n    );\n  }\n  await renderPodfileAsync(\n    path.join(\n      expoTemplateDirectory,\n      'template-files',\n      'ios',\n      'ExpoKit-Podfile'\n    ),\n    path.join(iosProjectDirectory, 'Podfile'),\n    podfileSubstitutions,\n    sdkVersion\n  );\n\n  console.log('Cleaning up iOS...');\n  await cleanPropertyListBackupsAsync(supportingDirectory);\n\n  if (!process.env.EXPO_VIEW_DIR) {\n    rimrafDontThrow(expoTemplateDirectory);\n  }\n\n  console.log(`iOS detach is complete!`);\n  return;\n}\n\nasync function _renameAndMoveIOSFilesAsync(\n  projectDirectory,\n  projectName,\n  manifest\n) {\n  // remove .gitignore, as this actually pertains to internal expo template management\n  try {\n    const gitIgnorePath = path.join(projectDirectory, '.gitignore');\n    if (fs.existsSync(gitIgnorePath)) {\n      rimraf.sync(gitIgnorePath);\n    }\n  } catch (e) {}\n\n  const filesToTransform = [\n    path.join('exponent-view-template.xcodeproj', 'project.pbxproj'),\n    path.join('exponent-view-template.xcworkspace', 'contents.xcworkspacedata'),\n    path.join(\n      'exponent-view-template.xcodeproj',\n      'xcshareddata',\n      'xcschemes',\n      'exponent-view-template.xcscheme'\n    ),\n  ];\n\n  const bundleIdentifier =\n    manifest.ios && manifest.ios.bundleIdentifier\n      ? manifest.ios.bundleIdentifier\n      : '';\n\n  await Promise.all(\n    filesToTransform.map(async fileName => {\n      return transformFileContentsAsync(\n        path.join(projectDirectory, fileName),\n        fileString => {\n          return fileString\n            .replace(\n              /com.getexponent.exponent-view-template/g,\n              bundleIdentifier\n            )\n            .replace(/exponent-view-template/g, projectName);\n        }\n      );\n    })\n  );\n\n  // order of this array matters\n  const filesToMove = [\n    'exponent-view-template',\n    path.join(\n      'exponent-view-template.xcodeproj',\n      'xcshareddata',\n      'xcschemes',\n      'exponent-view-template.xcscheme'\n    ),\n    'exponent-view-template.xcodeproj',\n    'exponent-view-template.xcworkspace',\n  ];\n\n  filesToMove.forEach(async fileName => {\n    let destFileName = path.join(\n      path.dirname(fileName),\n      `${projectName}${path.extname(fileName)}`\n    );\n    await spawnAsync('/bin/mv', [\n      path.join(projectDirectory, fileName),\n      path.join(projectDirectory, destFileName),\n    ]);\n  });\n\n  return;\n}\n\nasync function regexFileAsync(filename, regex, replace) {\n  let file = await fs.promise.readFile(filename);\n  let fileString = file.toString();\n  await fs.promise.writeFile(filename, fileString.replace(regex, replace));\n}\n\nasync function renamePackageAsync(directory, originalPkg, destPkg) {\n  let originalSplitPackage = originalPkg.split('.');\n  let originalDeepDirectory = directory;\n  for (let i = 0; i < originalSplitPackage.length; i++) {\n    originalDeepDirectory = path.join(\n      originalDeepDirectory,\n      originalSplitPackage[i]\n    );\n  }\n\n  // copy files into temp directory\n  let tmpDirectory = path.join(directory, 'tmp-exponent-directory');\n  mkdirp.sync(tmpDirectory);\n  await Utils.ncpAsync(originalDeepDirectory, tmpDirectory);\n\n  // delete old package\n  rimraf.sync(path.join(directory, originalSplitPackage[0]));\n\n  // make new package\n  let newSplitPackage = destPkg.split('.');\n  let newDeepDirectory = directory;\n  for (let i = 0; i < newSplitPackage.length; i++) {\n    newDeepDirectory = path.join(newDeepDirectory, newSplitPackage[i]);\n    mkdirp.sync(newDeepDirectory);\n  }\n\n  // copy from temp to new package\n  await Utils.ncpAsync(tmpDirectory, newDeepDirectory);\n\n  // delete temp\n  rimraf.sync(tmpDirectory);\n}\n\nasync function detachAndroidAsync(\n  projectRoot,\n  expoDirectory,\n  sdkVersion,\n  experienceUrl,\n  manifest,\n  expoViewUrl: string\n) {\n  let tmpExpoDirectory;\n  if (process.env.EXPO_VIEW_DIR) {\n    // Only for testing\n    tmpExpoDirectory = process.env.EXPO_VIEW_DIR;\n  } else {\n    tmpExpoDirectory = path.join(projectRoot, 'temp-android-directory');\n    mkdirp.sync(tmpExpoDirectory);\n    console.log('Downloading Android code...');\n    await Api.downloadAsync(expoViewUrl, tmpExpoDirectory, { extract: true });\n  }\n\n  let androidProjectDirectory = path.join(projectRoot, 'android');\n\n  console.log('Moving Android project files...');\n\n  await Utils.ncpAsync(\n    path.join(tmpExpoDirectory, 'android', 'maven'),\n    path.join(expoDirectory, 'maven')\n  );\n  await Utils.ncpAsync(\n    path.join(tmpExpoDirectory, 'android', 'detach-scripts'),\n    path.join(expoDirectory, 'detach-scripts')\n  );\n  await Utils.ncpAsync(\n    path.join(tmpExpoDirectory, 'exponent-view-template', 'android'),\n    androidProjectDirectory\n  );\n  if (process.env.EXPO_VIEW_DIR) {\n    rimraf.sync(path.join(androidProjectDirectory, 'build'));\n    rimraf.sync(path.join(androidProjectDirectory, 'app', 'build'));\n  }\n\n  // Fix up app/build.gradle\n  console.log('Configuring Android project...');\n  let appBuildGradle = path.join(\n    androidProjectDirectory,\n    'app',\n    'build.gradle'\n  );\n  await regexFileAsync(appBuildGradle, /\\/\\* UNCOMMENT WHEN DISTRIBUTING/g, '');\n  await regexFileAsync(\n    appBuildGradle,\n    /END UNCOMMENT WHEN DISTRIBUTING \\*\\//g,\n    ''\n  );\n  await regexFileAsync(appBuildGradle, `compile project(':expoview')`, '');\n\n  // Fix AndroidManifest\n  let androidManifest = path.join(\n    androidProjectDirectory,\n    'app',\n    'src',\n    'main',\n    'AndroidManifest.xml'\n  );\n  await regexFileAsync(\n    androidManifest,\n    'PLACEHOLDER_DETACH_SCHEME',\n    manifest.detach.scheme\n  );\n\n  // Fix MainActivity\n  let mainActivity = path.join(\n    androidProjectDirectory,\n    'app',\n    'src',\n    'main',\n    'java',\n    'detach',\n    'app',\n    'template',\n    'pkg',\n    'name',\n    'MainActivity.java'\n  );\n  await regexFileAsync(mainActivity, 'TEMPLATE_INITIAL_URL', experienceUrl);\n\n  // Fix package name\n  let packageName = manifest.android.package;\n  await renamePackageAsync(\n    path.join(androidProjectDirectory, 'app', 'src', 'main', 'java'),\n    ANDROID_TEMPLATE_PKG,\n    packageName\n  );\n  await renamePackageAsync(\n    path.join(androidProjectDirectory, 'app', 'src', 'test', 'java'),\n    ANDROID_TEMPLATE_PKG,\n    packageName\n  );\n  await renamePackageAsync(\n    path.join(androidProjectDirectory, 'app', 'src', 'androidTest', 'java'),\n    ANDROID_TEMPLATE_PKG,\n    packageName\n  );\n\n  let packageNameMatches = await glob.promise(\n    androidProjectDirectory + '/**/*.@(java|gradle|xml)'\n  );\n  if (packageNameMatches) {\n    let oldPkgRegex = new RegExp(\n      `${ANDROID_TEMPLATE_PKG.replace(/\\./g, '\\\\.')}`,\n      'g'\n    );\n    for (let i = 0; i < packageNameMatches.length; i++) {\n      await regexFileAsync(packageNameMatches[i], oldPkgRegex, packageName);\n    }\n  }\n\n  // Fix app name\n  console.log('Naming Android project...');\n  let appName = manifest.name;\n  await regexFileAsync(\n    path.resolve(\n      androidProjectDirectory,\n      'app',\n      'src',\n      'main',\n      'res',\n      'values',\n      'strings.xml'\n    ),\n    ANDROID_TEMPLATE_NAME,\n    appName\n  );\n\n  // Fix image\n  let icon =\n    manifest.android && manifest.android.icon\n      ? manifest.android.icon\n      : manifest.icon;\n  if (icon) {\n    let iconMatches = await glob.promise(\n      path.join(androidProjectDirectory, 'app', 'src', 'main', 'res') +\n        '/**/ic_launcher.png'\n    );\n    if (iconMatches) {\n      for (let i = 0; i < iconMatches.length; i++) {\n        await fs.promise.unlink(iconMatches[i]);\n        // TODO: make more efficient\n        await saveImageToPathAsync(projectRoot, icon, iconMatches[i]);\n      }\n    }\n  }\n\n  // Clean up\n  console.log('Cleaning up Android...');\n  if (!process.env.EXPO_VIEW_DIR) {\n    rimrafDontThrow(tmpExpoDirectory);\n  }\n  console.log('Android detach is complete!\\n');\n}\n\nasync function ensureBuildConstantsExistsIOSAsync(configFilePath: string) {\n  // EXBuildConstants is included in newer ExpoKit projects.\n  // create it if it doesn't exist.\n  const doesBuildConstantsExist = fs.existsSync(\n    path.join(configFilePath, 'EXBuildConstants.plist')\n  );\n  if (!doesBuildConstantsExist) {\n    await IosPlist.createBlankAsync(configFilePath, 'EXBuildConstants');\n    console.log(\n      'Created `EXBuildConstants.plist` because it did not exist yet'\n    );\n  }\n  return;\n}\n\nasync function prepareDetachedBuildIosAsync(\n  projectDir: string,\n  exp: any,\n  args: any\n) {\n  let { iosProjectDirectory, projectName, supportingDirectory } = getIosPaths(\n    projectDir,\n    exp\n  );\n\n  console.log(`Preparing iOS build at ${iosProjectDirectory}...`);\n  // These files cause @providesModule naming collisions\n  // but are not available until after `pod install` has run.\n  let podsDirectory = path.join(iosProjectDirectory, 'Pods');\n  if (!_isDirectory(podsDirectory)) {\n    throw new Error(\n      `Can't find directory ${podsDirectory}, make sure you've run pod install.`\n    );\n  }\n  let rnPodDirectory = path.join(podsDirectory, 'React');\n  if (_isDirectory(rnPodDirectory)) {\n    let rnFilesToDelete = await glob.promise(\n      rnPodDirectory + '/**/*.@(js|json)'\n    );\n    if (rnFilesToDelete) {\n      for (let i = 0; i < rnFilesToDelete.length; i++) {\n        await fs.promise.unlink(rnFilesToDelete[i]);\n      }\n    }\n  }\n  // insert expo development url into iOS config\n  if (!args.skipXcodeConfig) {\n    // populate EXPO_RUNTIME_VERSION from ExpoKit pod version\n    let expoKitVersion = '';\n    const podfileLockPath = path.join(iosProjectDirectory, 'Podfile.lock');\n    try {\n      const podfileLock = await fs.promise.readFile(podfileLockPath, 'utf8');\n      const expoKitVersionRegex = /ExpoKit\\/Core\\W?\\(([0-9\\.]+)\\)/gi;\n      let match = expoKitVersionRegex.exec(podfileLock);\n      expoKitVersion = match[1];\n    } catch (e) {\n      throw new Error(\n        `Unable to read ExpoKit version from Podfile.lock. Make sure your project depends on ExpoKit. (${e})`\n      );\n    }\n\n    // populate development url\n    let devUrl = await UrlUtils.constructManifestUrlAsync(projectDir);\n\n    await ensureBuildConstantsExistsIOSAsync(supportingDirectory);\n    await IosPlist.modifyAsync(\n      supportingDirectory,\n      'EXBuildConstants',\n      constantsConfig => {\n        constantsConfig.developmentUrl = devUrl;\n        constantsConfig.EXPO_RUNTIME_VERSION = expoKitVersion;\n        return constantsConfig;\n      }\n    );\n  }\n}\n\nexport async function prepareDetachedBuildAsync(projectDir: string, args: any) {\n  let { exp } = await ProjectUtils.readConfigJsonAsync(projectDir);\n\n  if (args.platform === 'ios') {\n    await prepareDetachedBuildIosAsync(projectDir, exp, args);\n  } else {\n    let androidProjectDirectory = path.join(projectDir, 'android');\n    let expoBuildConstantsMatches = await glob.promise(\n      androidProjectDirectory + '/**/ExponentBuildConstants.java'\n    );\n    if (expoBuildConstantsMatches && expoBuildConstantsMatches.length) {\n      let expoBuildConstants = expoBuildConstantsMatches[0];\n      let devUrl = await UrlUtils.constructManifestUrlAsync(projectDir);\n      await regexFileAsync(\n        expoBuildConstants,\n        /DEVELOPMENT_URL \\= \\\"[^\\\"]*\\\"\\;/,\n        `DEVELOPMENT_URL = \"${devUrl}\";`\n      );\n    }\n  }\n}\n"],"sourceRoot":"/xdl/src"}